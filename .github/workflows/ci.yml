name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  go-agent:
    name: Go Agent (build + test + lint)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: agent
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache-dependency-path: agent/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Build agent
        run: go build -ldflags "-X main.version=ci -X main.gitCommit=${{ github.sha }}" -o bin/kubecomply-agent ./cmd/agent

      - name: Build CLI
        run: go build -ldflags "-X main.version=ci -X main.gitCommit=${{ github.sha }}" -o bin/kubecomply ./cmd/cli

      - name: Run tests
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: Upload coverage
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: agent/coverage.out

  opa-policies:
    name: OPA Policy Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Run policy tests
        run: opa test policies/ -v

      - name: Check policy formatting
        run: opa fmt --fail policies/

  helm-chart:
    name: Helm Chart Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint chart
        run: helm lint charts/kubecomply

      - name: Template chart
        run: helm template kubecomply charts/kubecomply
